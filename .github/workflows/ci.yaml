name: CI

on:
  push:
  pull_request:
    branches: [ main ]

jobs:
  govulncheck:
    name: Vulnerability Scan (govulncheck)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck -show verbose ./...

  gosec:
    name: Static Security Analysis (gosec)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: gosec -fmt=text ./...

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [govulncheck, gosec]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Run tests
        run: go test -v -count=1 ./...

      - name: Check test coverage
        run: |
          go test -coverprofile=coverage.out -covermode=count ./...
          go tool cover -func=coverage.out

  docker-integration-test:
    name: Docker Integration Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Linux binary
        run: GOOS=linux GOARCH=amd64 go build -o dist/platform-spec-linux ./cmd/platform-spec

      - name: Build Docker test image
        run: docker build -f integration/docker/Dockerfile.test -t platform-spec-test .

      - name: Run Docker integration tests
        run: docker run --rm platform-spec-test

  kubernetes-integration-test:
    name: Kubernetes Integration Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: platform-spec-test
          config: integration/kubernetes/kind-config.yaml
          wait: 60s

      - name: Build binary
        run: go build -o dist/platform-spec ./cmd/platform-spec

      - name: Run Kubernetes integration tests
        run: ./dist/platform-spec test kubernetes examples/kubernetes-basic.yaml --verbose

  jump-host-integration-test:
    name: SSH Jump Host Integration Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build binary
        run: go build -o dist/platform-spec ./cmd/platform-spec

      - name: Generate SSH keypairs
        run: |
          mkdir -p integration/jump-host/ssh-keys
          ssh-keygen -t rsa -b 2048 -f integration/jump-host/ssh-keys/jump_key -N "" -C "platform-spec-jump"
          ssh-keygen -t rsa -b 2048 -f integration/jump-host/ssh-keys/target_key -N "" -C "platform-spec-target"
          chmod 600 integration/jump-host/ssh-keys/jump_key integration/jump-host/ssh-keys/target_key

      - name: Build and start jump host containers
        run: |
          cd integration/jump-host
          docker compose up -d --build
          sleep 10

      - name: Wait for containers to be ready
        run: |
          timeout 30 sh -c 'until docker exec platform-spec-jump pgrep sshd > /dev/null; do sleep 1; done'
          timeout 30 sh -c 'until docker exec platform-spec-target pgrep sshd > /dev/null; do sleep 1; done'

      - name: Copy SSH keys into containers
        run: |
          echo "Copying jump host authorized_keys..."
          docker cp integration/jump-host/ssh-keys/jump_key.pub platform-spec-jump:/tmp/authorized_keys
          docker exec platform-spec-jump sh -c 'mv /tmp/authorized_keys /home/testuser/.ssh/authorized_keys && chown testuser:testuser /home/testuser/.ssh/authorized_keys && chmod 600 /home/testuser/.ssh/authorized_keys'

          echo "Copying target host authorized_keys..."
          docker cp integration/jump-host/ssh-keys/target_key.pub platform-spec-target:/tmp/authorized_keys
          docker exec platform-spec-target sh -c 'mv /tmp/authorized_keys /home/testuser/.ssh/authorized_keys && chown testuser:testuser /home/testuser/.ssh/authorized_keys && chmod 600 /home/testuser/.ssh/authorized_keys'

          echo "Restarting sshd in containers..."
          docker exec platform-spec-jump pkill -HUP sshd || true
          docker exec platform-spec-target pkill -HUP sshd || true
          sleep 2

      - name: Verify SSH is accepting connections
        run: |
          echo "Checking jump host authorized_keys..."
          docker exec platform-spec-jump cat /home/testuser/.ssh/authorized_keys
          echo "Checking target host authorized_keys..."
          docker exec platform-spec-target cat /home/testuser/.ssh/authorized_keys
          echo "Testing SSH connection to jump host..."
          timeout 10 sh -c 'until ssh -o StrictHostKeyChecking=no -o BatchMode=yes -p 2222 -i integration/jump-host/ssh-keys/jump_key testuser@localhost exit 2>&1 | grep -qv "Permission denied"; do sleep 1; done' || true
          sleep 2

      - name: Test jump host with correct keys
        run: |
          ./dist/platform-spec test remote \
            -J testuser@localhost \
            --jump-port 2222 \
            --jump-identity integration/jump-host/ssh-keys/jump_key \
            -i integration/jump-host/ssh-keys/target_key \
            testuser@target-host \
            integration/jump-host/spec.yaml \
            --insecure-ignore-host-key \
            --verbose

      - name: Test jump host with wrong jump key (should fail)
        run: |
          if ./dist/platform-spec test remote \
            -J testuser@localhost \
            --jump-port 2222 \
            --jump-identity integration/jump-host/ssh-keys/target_key \
            -i integration/jump-host/ssh-keys/jump_key \
            testuser@target-host \
            integration/jump-host/spec.yaml \
            --insecure-ignore-host-key 2>&1 | grep -q "failed to connect to jump host"; then
            echo "✓ Correctly rejected wrong jump key"
          else
            echo "✗ Should have failed with wrong jump key"
            exit 1
          fi

      - name: Test jump host with wrong target key (should fail)
        run: |
          if ./dist/platform-spec test remote \
            -J testuser@localhost \
            --jump-port 2222 \
            --jump-identity integration/jump-host/ssh-keys/jump_key \
            -i integration/jump-host/ssh-keys/jump_key \
            testuser@target-host \
            integration/jump-host/spec.yaml \
            --insecure-ignore-host-key 2>&1 | grep -q "failed to establish SSH connection to target"; then
            echo "✓ Correctly rejected wrong target key"
          else
            echo "✗ Should have failed with wrong target key"
            exit 1
          fi

      - name: Cleanup jump host environment
        if: always()
        run: |
          cd integration/jump-host
          docker compose down -v || true
          rm -rf ssh-keys

  inventory-integration-test:
    name: Inventory File Integration Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build binary
        run: go build -o dist/platform-spec ./cmd/platform-spec

      - name: Build Linux binary for container (statically linked for Alpine)
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o dist/platform-spec-linux ./cmd/platform-spec

      - name: Generate SSH key
        run: |
          mkdir -p integration
          ssh-keygen -t rsa -b 2048 -f integration/test_key -N "" -q
          chmod 600 integration/test_key

      - name: Create Docker network
        run: docker network create platform-spec-test-net

      - name: Start SSH containers
        run: |
          cd integration
          docker compose up -d
          sleep 10

      - name: Wait for containers to be ready
        run: |
          timeout 60 sh -c 'until docker exec platform-spec-test-1 pgrep sshd > /dev/null; do sleep 1; done'
          timeout 60 sh -c 'until docker exec platform-spec-test-2 pgrep sshd > /dev/null; do sleep 1; done'
          timeout 60 sh -c 'until docker exec platform-spec-test-3 pgrep sshd > /dev/null; do sleep 1; done'
          echo "All containers are ready"

      - name: Setup SSH access
        run: |
          PUBKEY=$(cat integration/test_key.pub)
          for i in 1 2 3; do
            docker exec platform-spec-test-$i mkdir -p /config/.ssh
            docker exec platform-spec-test-$i sh -c "echo '$PUBKEY' >> /config/.ssh/authorized_keys"
            docker exec platform-spec-test-$i chmod 700 /config/.ssh
            docker exec platform-spec-test-$i chmod 600 /config/.ssh/authorized_keys
            docker exec platform-spec-test-$i chown -R testuser:testuser /config/.ssh
          done
          echo "SSH access configured"

      - name: Connect containers to test network
        run: |
          for i in 1 2 3; do
            docker network connect platform-spec-test-net platform-spec-test-$i || true
          done

      - name: Create inventory file
        run: |
          cat > integration/inventory-hosts.txt <<EOF
          # Test inventory with Docker container names
          testuser@platform-spec-test-1
          testuser@platform-spec-test-2
          testuser@platform-spec-test-3
          EOF
          echo "Inventory file created:"
          cat integration/inventory-hosts.txt

      - name: Verify binary exists and make executable
        run: |
          ls -lh dist/
          file dist/platform-spec-linux
          chmod +x dist/platform-spec-linux

      - name: Run inventory integration test
        run: |
          docker run --rm \
            --network platform-spec-test-net \
            -v $PWD/dist/platform-spec-linux:/platform-spec:ro \
            -v $PWD/integration/test-spec.yaml:/spec.yaml:ro \
            -v $PWD/integration/inventory-hosts.txt:/inventory.txt:ro \
            -v $PWD/integration/test_key:/ssh_key:ro \
            alpine:latest \
            /platform-spec test remote \
            --inventory /inventory.txt \
            /spec.yaml \
            -i /ssh_key \
            -p 2222 \
            --insecure-ignore-host-key \
            --no-color

      - name: Verify multi-host output
        run: |
          echo "✓ Inventory integration test completed successfully"
          echo "  - Tested 3 hosts from inventory file"
          echo "  - All hosts passed SSH connectivity tests"
          echo "  - Multi-host output format validated"

      - name: Cleanup inventory test environment
        if: always()
        run: |
          cd integration
          docker compose down -v || true
          docker network rm platform-spec-test-net || true
          rm -f test_key test_key.pub inventory-hosts.txt ssh_config || true

  parallel-execution-test:
    name: Parallel Execution Performance Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build binary
        run: go build -o dist/platform-spec ./cmd/platform-spec

      - name: Build Linux binary for container
        run: GOOS=linux GOARCH=amd64 go build -o dist/platform-spec-linux ./cmd/platform-spec

      - name: Generate SSH key
        run: |
          mkdir -p integration
          ssh-keygen -t rsa -b 2048 -f integration/perf-test-key -N "" -q
          chmod 600 integration/perf-test-key

      - name: Create Docker network
        run: docker network create platform-spec-perf-test

      - name: Start 30 SSH containers
        run: |
          cd integration
          docker compose -f docker-compose-test.yml up -d ssh-test-{1..30}
          sleep 15

      - name: Wait for containers to be ready
        run: |
          echo "Waiting for SSH services to start..."
          for i in {1..60}; do
            ready=0
            for j in {1..30}; do
              if docker exec ssh-test-$j pgrep sshd > /dev/null 2>&1; then
                ready=$((ready + 1))
              fi
            done
            if [ $ready -eq 30 ]; then
              echo "All 30 containers ready"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Timeout waiting for containers"
              exit 1
            fi
            sleep 1
          done

      - name: Setup SSH access
        run: |
          PUBKEY=$(cat integration/perf-test-key.pub)
          for i in {1..30}; do
            docker exec ssh-test-$i mkdir -p /config/.ssh 2>/dev/null || true
            docker exec ssh-test-$i sh -c "echo '$PUBKEY' > /config/.ssh/authorized_keys"
            docker exec ssh-test-$i chmod 700 /config/.ssh
            docker exec ssh-test-$i chmod 600 /config/.ssh/authorized_keys
            docker exec ssh-test-$i chown -R testuser:testuser /config/.ssh
          done
          echo "SSH access configured for all containers"

      - name: Connect containers to test network
        run: |
          for i in {1..30}; do
            docker network connect platform-spec-perf-test ssh-test-$i 2>/dev/null || true
          done

      - name: Create inventory files
        run: |
          cd integration
          echo "testuser@ssh-test-1" > perf-inventory-1.txt
          for i in {1..30}; do
            echo "testuser@ssh-test-$i" >> perf-inventory-30.txt
          done

      - name: Create SSH config
        run: |
          cd integration
          cat > ssh_config <<EOF
          Host *
              User testuser
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          EOF

      - name: Verify SSH connectivity
        run: |
          docker run --rm \
            --network platform-spec-perf-test \
            -v $PWD/integration/perf-test-key:/ssh_key:ro \
            -v $PWD/integration/ssh_config:/etc/ssh/ssh_config:ro \
            alpine:latest \
            sh -c "apk add --no-cache openssh-client > /dev/null 2>&1 && ssh -i /ssh_key -p 2222 ssh-test-1 'echo Connected'" | grep -q "Connected"
          echo "✓ SSH connectivity verified"

      - name: Test single host baseline
        run: |
          START=$(date +%s.%N)
          docker run --rm \
            --network platform-spec-perf-test \
            -v $PWD/dist/platform-spec-linux:/platform-spec:ro \
            -v $PWD/integration/perf-test-spec.yaml:/spec.yaml:ro \
            -v $PWD/integration/perf-inventory-1.txt:/inventory.txt:ro \
            -v $PWD/integration/perf-test-key:/ssh_key:ro \
            -v $PWD/integration/ssh_config:/etc/ssh/ssh_config:ro \
            alpine:latest \
            /platform-spec test remote --inventory /inventory.txt /spec.yaml -i /ssh_key -p 2222 --insecure-ignore-host-key
          END=$(date +%s.%N)
          TIME_1=$(echo "$END - $START" | bc)
          echo "✓ Single host: ${TIME_1}s"
          echo "TIME_1=${TIME_1}" >> $GITHUB_ENV

      - name: Test 30 hosts sequential
        run: |
          START=$(date +%s.%N)
          docker run --rm \
            --network platform-spec-perf-test \
            -v $PWD/dist/platform-spec-linux:/platform-spec:ro \
            -v $PWD/integration/perf-test-spec.yaml:/spec.yaml:ro \
            -v $PWD/integration/perf-inventory-30.txt:/inventory.txt:ro \
            -v $PWD/integration/perf-test-key:/ssh_key:ro \
            -v $PWD/integration/ssh_config:/etc/ssh/ssh_config:ro \
            alpine:latest \
            /platform-spec test remote --inventory /inventory.txt /spec.yaml -i /ssh_key -p 2222 --insecure-ignore-host-key --parallel 1
          END=$(date +%s.%N)
          TIME_SEQ=$(echo "$END - $START" | bc)
          echo "✓ Sequential (30 hosts): ${TIME_SEQ}s"
          echo "TIME_SEQ=${TIME_SEQ}" >> $GITHUB_ENV

      - name: Test 30 hosts parallel (10 workers)
        run: |
          START=$(date +%s.%N)
          docker run --rm \
            --network platform-spec-perf-test \
            -v $PWD/dist/platform-spec-linux:/platform-spec:ro \
            -v $PWD/integration/perf-test-spec.yaml:/spec.yaml:ro \
            -v $PWD/integration/perf-inventory-30.txt:/inventory.txt:ro \
            -v $PWD/integration/perf-test-key:/ssh_key:ro \
            -v $PWD/integration/ssh_config:/etc/ssh/ssh_config:ro \
            alpine:latest \
            /platform-spec test remote --inventory /inventory.txt /spec.yaml -i /ssh_key -p 2222 --insecure-ignore-host-key --parallel 10
          END=$(date +%s.%N)
          TIME_PAR10=$(echo "$END - $START" | bc)
          echo "✓ Parallel (10 workers): ${TIME_PAR10}s"
          echo "TIME_PAR10=${TIME_PAR10}" >> $GITHUB_ENV

      - name: Test 30 hosts parallel (30 workers)
        run: |
          START=$(date +%s.%N)
          docker run --rm \
            --network platform-spec-perf-test \
            -v $PWD/dist/platform-spec-linux:/platform-spec:ro \
            -v $PWD/integration/perf-test-spec.yaml:/spec.yaml:ro \
            -v $PWD/integration/perf-inventory-30.txt:/inventory.txt:ro \
            -v $PWD/integration/perf-test-key:/ssh_key:ro \
            -v $PWD/integration/ssh_config:/etc/ssh/ssh_config:ro \
            alpine:latest \
            /platform-spec test remote --inventory /inventory.txt /spec.yaml -i /ssh_key -p 2222 --insecure-ignore-host-key --parallel 30
          END=$(date +%s.%N)
          TIME_PAR30=$(echo "$END - $START" | bc)
          echo "✓ Parallel (30 workers): ${TIME_PAR30}s"
          echo "TIME_PAR30=${TIME_PAR30}" >> $GITHUB_ENV

      - name: Calculate and verify speedup
        run: |
          SPEEDUP_10=$(echo "scale=2; $TIME_SEQ / $TIME_PAR10" | bc)
          SPEEDUP_30=$(echo "scale=2; $TIME_SEQ / $TIME_PAR30" | bc)

          echo "=================================="
          echo "Performance Results (30 hosts)"
          echo "=================================="
          echo "Sequential (1 worker):  ${TIME_SEQ}s"
          echo "Parallel (10 workers):  ${TIME_PAR10}s (${SPEEDUP_10}x speedup)"
          echo "Parallel (30 workers):  ${TIME_PAR30}s (${SPEEDUP_30}x speedup)"
          echo "=================================="

          # Verify we achieved at least 2x speedup with 10 workers
          if [ $(echo "$SPEEDUP_10 >= 2.0" | bc) -eq 1 ]; then
            echo "✅ SUCCESS: Parallel execution achieves >2x speedup (${SPEEDUP_10}x)"
          else
            echo "❌ FAIL: Speedup is below 2x (got ${SPEEDUP_10}x)"
            exit 1
          fi

      - name: Cleanup parallel test environment
        if: always()
        run: |
          cd integration
          docker compose -f docker-compose-test.yml down -v || true
          docker network rm platform-spec-perf-test || true
          rm -f perf-test-key perf-test-key.pub perf-inventory-*.txt ssh_config || true
